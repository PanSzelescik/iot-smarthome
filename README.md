# iot-smarthome

SmartHeating to aplikacja oparta na .NET 9 i PostgreSQL, umo≈ºliwiajƒÖca monitorowanie temperatury w pomieszczeniu.

https://iotsmarthomeapi.azurewebsites.net/

OpenAPI/Postman collection: https://iotsmarthomeapi.azurewebsites.net/swagger/v1/swagger.json

## ‚ú® Funkcje

- **Zbieranie danych** ‚Äì Rejestrowanie temperatury w czasie rzeczywistym i zapisywanie jej w bazie danych.
- **Automatyczne sterowanie ogrzewaniem** ‚Äì W≈ÇƒÖczanie i wy≈ÇƒÖczanie grzejnika czy klimy na podstawie zadanych prog√≥w temperatury.
- **Analiza danych** ‚Äì Obliczanie ≈õredniej temperatury w okre≈õlonym przedziale czasowym, maksymalnej, minimalnej, przeliczanie na r√≥≈ºne jednostki.

## üõ† Technologie

- **Backend:** .NET 9 (ASP.NET Core)
- **Baza danych:** PostgreSQL

## üôã‚Äç‚ôÇÔ∏è User stories
1. Utrzymanie komfortowej temperatury w pomieszczeniu:

Jako u≈ºytkownik
chcia≈Çbym m√≥c ustawiƒá docelowƒÖ temperaturƒô,
przy kt√≥rej grzejnik w≈ÇƒÖczy siƒô,
po to, aby podnie≈õƒá temperaturƒô w pomieszczeniu do komfortowego poziomu (lub klimƒô, aby obli≈ºyƒá), 
oraz temperaturƒô, przy kt√≥rej grzejnik automatycznie siƒô wy≈ÇƒÖczy, aby nie przegrzewaƒá pomieszczenia. 
Dziƒôki temu system grzewczy dzia≈Ça≈Çby w spos√≥b efektywny, utrzymujƒÖc sta≈ÇƒÖ, komfortowƒÖ temperaturƒô w pomieszczeniu, 
unikajƒÖc jednocze≈õnie zbƒôdnego zu≈ºycia energii. Moje ustawienia powinny byƒá elastyczne i umo≈ºliwiaƒá ≈ÇatwƒÖ regulacjƒô 
w zale≈ºno≈õci od pory dnia czy preferencji, zapewniajƒÖc optymalny komfort cieplny.

2. Monitorowanie temperatury:

Jako u≈ºytkownik
chcia≈Çbym, aby temperatura by≈Ça wy≈õwietlana w czasie rzeczywistym,
po to, aby w razie potrzeby szybko zareagowaƒá i dostosowaƒá ustawienia grzejnika 
lub klimatyzatora, zapewniajƒÖc optymalny komfort cieplny. Dodatkowo,
przydatne by≈Çoby mieƒá mo≈ºliwo≈õƒá sprawdzenia historii temperatury, 
aby analizowaƒá, jak zmienia≈Ça siƒô temperatura w ciƒÖgu dnia lub tygodnia.

3. Historia temperatury:

Jako u≈ºytkownik
chcia≈Çbym mieƒá mo≈ºliwo≈õƒá przeglƒÖdania historii zmian temperatury w pomieszczeniu,
po to, aby m√≥c analizowaƒá, jak temperatura zmienia≈Ça siƒô w r√≥≈ºnych porach dnia i nocy. 
Analiza takich danych u≈Çatwi≈Çaby mi tak≈ºe planowanie, jak najlepiej wykorzystaƒá system grzewczy 
w zale≈ºno≈õci od zmieniajƒÖcych siƒô warunk√≥w w ciƒÖgu dnia lub tygodnia.

4. Obliczanie ≈õredniej temperatury:

Jako u≈ºytkownik
chcia≈Çbym m√≥c zobaczyƒá ≈õredniƒÖ temperaturƒô z wybranego okresu
po to, aby oceniƒá, jak efektywnie dzia≈Ça ogrzewanie

5. Obs≈Çuga r√≥≈ºnych jednostek temperatury:

Jako u≈ºytkownik
chcia≈Çbym m√≥c wybraƒá jednostkƒô temperatury (¬∞C, ¬∞F lub K)
po to, aby dostosowaƒá system do moich preferencji.

6. Oszczƒôdzanie energii:

Jako u≈ºytkownik
chcia≈Çbym m√≥c aktywowaƒá tryb oszczƒôdzania energii
po to, aby zmniejszyƒá zu≈ºycie energii, gdy nie ma mnie w pomieszczeniu.

## üìä Diagram architektury - C4 model

![image](https://github.com/user-attachments/assets/f20d7679-d5e1-4fd7-8d2a-66174d13a9cd)

![image](https://github.com/user-attachments/assets/844c5a89-de03-4431-ad48-e0a62d190b5e)

## üí∞ Cost Calculator
![Azure_Cost_Calculator](https://github.com/PanSzelescik/iot-smarthome/blob/main/Azure_Cost_Calculator.png)

## üö® Instalacja

### Azure Database for PostgreSQL
1. Zaloguj siƒô do portalu Azure i uruchom Cloud Shell.
2. Ustaw zmienne
```sh
let "randomIdentifier=$RANDOM*$RANDOM"
location="polandcentral"
resourceGroup="pg-rg-$randomIdentifier"
server="pg-server-$randomIdentifier"
sku="Standard_D2ds_v4"
login="azureuser"
password="Pa$$w0rD-$randomIdentifier"
startIp=0.0.0.0
endIp=0.0.0.0
```
3. Utw√≥rz grupƒô zasob√≥w
```sh
az group create --name $resourceGroup --location $location
```
4. Utw√≥rz serwer PostgreSQL Flexible Server
```sh
az postgres flexible-server create \
  --name $server \
  --resource-group $resourceGroup \
  --location $location \
  --admin-user $login \
  --admin-password $password \
  --sku-name $sku
```
5. Skonfiguruj regu≈Çƒô zapory, aby zezwoliƒá na dostƒôp z dowolnego adresu IP (zr√≥b to tylko dla serwera testowego, w produkcji nale≈ºy ograniczyƒá dostƒôp do okre≈õlonych adres√≥w IP)
```sh
az postgres flexible-server firewall-rule create \
  --resource-group $resourceGroup \
  --name AllowAll \
  --server-name $server \
  --start-ip-address $startIp \
  --end-ip-address $endIp
```
6. Pobierz Connection Stringa wybierajƒÖc serwer bazy danych na Azure > Settings > Connect. Wybierz odpowiedni database, Authentication Method jako PostgreSQL. Nastƒôpnie rozwi≈Ñ Connect from your app i skopiuj ADO.NET
![image](https://github.com/user-attachments/assets/cd5f564d-8f77-4bd2-b91b-f3439f020308)

### Azure IoT Hub
1. Zaloguj siƒô do portalu Azure i uruchom Cloud Shell.
2. Zainstaluj rozszerzenie IoT dla Azure CLI
```sh
az extension add --upgrade --name azure-iot
```
3. Ustaw zmienne
```sh
location="polandcentral"
resourceGroup="iot-rg"
iotHubName="my-iothub-$(openssl rand -hex 3)"
```
4. Utw√≥rz grupƒô zasob√≥w
```sh
az group create --name $resourceGroup --location $location
```
5. Utw√≥rz IoT Hub
```sh
az iot hub create --resource-group $resourceGroup --name $iotHubName --location $location --sku S1
```
6. Pobierz Connection Stringa, aby API mog≈Ço wysy≈Çaƒá dane do urzƒÖdze≈Ñ:
```sh
az iot hub show-connection-string --name iotsmarthomeiothub --resource-group ProjektIotHub --output table
```
7. Przejd≈∫ do IoT Hub w portalu Azure > Devices i kliknij Add Device aby dodaƒá nowe urzƒÖdzenie
![brave_NUq6FX3zQV](https://github.com/user-attachments/assets/f33ee14d-0cb7-4984-a6d7-26216c776a4b)
8. Ustaw tylko Device ID i kliknij Save
![brave_2pgrBNp3br](https://github.com/user-attachments/assets/bba2e1d9-0413-4ddb-8a2d-986e9f3223cc)
9. Nastƒôpnie kliknij na nowo utworzone urzƒÖdzenie i skopiuj Connection Stringa, kt√≥ry bƒôdzie potrzebny do konfiguracji urzƒÖdzenia
![brave_tIA8AyZOyw](https://github.com/user-attachments/assets/9a127946-47e8-4c4e-b501-be725c977831)
![brave_kNCwXz8YPU](https://github.com/user-attachments/assets/20c2618a-e573-4aae-9b5c-3282dfb9aab3)
10. Przejd≈∫ do zak≈Çadki Hub settings > Built-in endpoints i skopiuj Event Hub-compatible name oraz Event Hub-compatible endpoint
![image](https://github.com/user-attachments/assets/943e8d80-c6d7-4c2a-815b-a95649d143d2)
![image](https://github.com/user-attachments/assets/cee824f2-843d-47dc-9f00-aa8a179eea5b)

### Azure Functions
1. Zaloguj siƒô do portalu Azure i uruchom Cloud Shell.
2. Ustaw zmienne
```sh
let "randomIdentifier=$RANDOM*$RANDOM"
location="polandcentral"
resourceGroup="func-rg-$randomIdentifier"
storage="funcstorage$randomIdentifier"
plan="func-plan-$randomIdentifier"
functionApp="func-app-$randomIdentifier"
```
3. Utw√≥rz grupƒô zasob√≥w
```sh
az group create --name $resourceGroup --location $location
```
4. Utw√≥rz Storage Account
```sh
az storage account create --name $storage --location $location --resource-group $resourceGroup --sku Standard_LRS
```
5. Utw√≥rz plan App Service (Consumption Plan, Linux)
```sh
az functionapp plan create \
  --resource-group $resourceGroup \
  --name $plan \
  --location $location \
  --number-of-workers 1 \
  --sku Y1 \
  --is-linux
```
6. Utw√≥rz Function App z obs≈ÇugƒÖ .NET 9 (isolated)
```sh
az functionapp create \
   --resource-group $resourceGroup \
   --plan $plan \
   --runtime dotnet-isolated \
   --functions-version 4 \
   --name $functionApp \
   --storage-account $storage \
   --os-type Linux
```
7. Dodaj zmienne ≈õrodowiskowe
```sh
az functionapp config appsettings set \
  --name $functionApp \
  --resource-group $resourceGroup \
  --settings "HOME_ASSISTANT_TOKEN=value" "IOTHUB_DEVICE_CONNECTION_STRING_POKOJ_SZYMONA=value" "IOTHUB_DEVICE_CONNECTION_STRING_SALON=value"
```
Gdzie `HOME_ASSISTANT_TOKEN` to token do Home Assistant (https://ha.panszelescik.pl/), a `IOTHUB_DEVICE_CONNECTION_STRING_POKOJ_SZYMONA` i `IOTHUB_DEVICE_CONNECTION_STRING_SALON` to Connection Stringi odpowiednio dla urzƒÖdze≈Ñ o Device ID `pokoj_szymona` i `salon` z Azure IoT Hub.
8. Kod symulatora znajduje siƒô w katalogu `simulator`, otw√≥rz solucjƒô za pomocƒÖ Ridera (upewnij siƒô, ≈ºe masz zainstalowany .NET 9 i plugin Azure Toolkit for Rider)
9. Kliknij prawym na solucjƒô i wybierz Publish, a nastƒôpnie Azure
![rider64_uKdt1Xg8JZ](https://github.com/user-attachments/assets/fc68e2ed-4b38-4d14-8136-f46c02d19fa1)
![rider64_dw6V8IMdtg](https://github.com/user-attachments/assets/86c585c0-e882-4274-8774-8383d39bf5cc)
10. Wybierz utworzony wcze≈õniej Function App (w razie potrzeby zaloguj siƒô) i kliknij Next aby zbudowaƒá solucjƒô i jƒÖ wys≈Çaƒá do Azure
![rider64_CERAjBeFbD](https://github.com/user-attachments/assets/3e026bc8-35fc-46fb-b140-bc45301a1c19)
11. Symulator co 15 minut bƒôdzie pobiera≈Ç prawdziwƒÖ temperaturƒô z Home Assistant i przesy≈Ça≈Ç je jako `pokoj_szymona` i `salon`. W razie potrzeby testowania mo≈ºesz u≈ºyƒá rƒôcznych funkcji: https://iotsmarthomesimulator.azurewebsites.net/api/pokoj_szymona?temperature=23.48&code=value gdzie:
- pokoj_szymona to Device ID urzƒÖdzenia
- temperature to temperatura w stopniach Celsjusza (pamiƒôtaj o kropce, nie przecinku)
- code to klucz zabezpieczajƒÖcy funkcjƒô, kt√≥ry znajdziesz w Functions > Keys > _master
![brave_uotyTGmp3N](https://github.com/user-attachments/assets/9551eeae-e243-4648-a4e3-ab9bab9b875e)

### Azure App Service
1. Zaloguj siƒô do portalu Azure i uruchom Cloud Shell.
2. Ustaw zmienne
```sh
let "randomIdentifier=$RANDOM*$RANDOM"
location="polandcentral"
resourceGroup="appservice-rg-$randomIdentifier"
appServicePlan="appservice-plan-$randomIdentifier"
webAppName="appservice-webapp-$randomIdentifier"
```
3. Utw√≥rz grupƒô zasob√≥w
```sh
az group create --name $resourceGroup --location $location
```
4. Utw√≥rz plan App Service
```sh
az appservice plan create \
  --name $appServicePlan \
  --resource-group $resourceGroup \
  --location $location \
  --sku B1 \
  --is-linux
```
5. Utw√≥rz Web App
```sh
az webapp create \
  --resource-group $resourceGroup \
  --plan $appServicePlan \
  --name $webAppName \
  --runtime "DOTNETCORE|9.0" \
  --deployment-local-git
```
6. Skonfiguruj zmienne ≈õrodowiskowe
```sh
az webapp config appsettings set \
  --resource-group $resourceGroup \
  --name $webAppName \
  --settings "ConnectionStrings__Postgres=value" "ConnectionStrings__EventHubName=value" "ConnectionStrings__EventHubCompatibleConnectionString=value" "ConnectionStrings__IoTHubConnectionString=value"
```
Gdzie ConnectionString `Postgres` to Connection String do bazy danych PostgreSQL, `EventHubName` to Event Hub-compatible name z Azure IoT Hub, `EventHubCompatibleConnectionString` to Event Hub-compatible endpoint z Azure IoT Hub, aby m√≥c odbieraƒá dane, a `IoTHubConnectionString` to Connection String do IoT Hub, aby m√≥c wysy≈Çaƒá dane.
7. Kod wdro≈ºysz identycznie jak w przypadku Azure Functions, czyli otwierajƒÖc solucjƒô w Riderze znajdujƒÖcƒÖ siƒô w folderze api i publikujƒÖc jƒÖ do Azure. Wybierz utworzony wcze≈õniej Web App i kliknij Next aby zbudowaƒá solucjƒô i jƒÖ wys≈Çaƒá do Azure
